<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Set List Creator</title>
<style>

.librarySong
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.setListSong
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.menuButton
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.dropbtn
{
  background-color: grey;
  color: white;
  padding: 5px;
  font-size: 16px;
  cursor: pointer;
}

.insert
{
  border: 5px solid white;
  background-color: #0f0;
  color: #444;
}

.dropbtn:hover
{
  background-color: brown;
}

.dropdown
{
  position: relative;
  display: inline-block;
  font-size: 15px;
  padding: 0px;
  text-align: center;
}

.dropdown-content
{
  display: none;
  position: absolute;
  background-color: rgb( 229, 226, 226 );
  overflow: auto;
  box-shadow: 0px 8px 16px 0px rgba( 0, 0, 0, 0.2 );
  z-index: 999;
}

.dropdown-content a
{
  color: black;
  padding: 2px;
  text-decoration: none;
  display: block;
  min-width: 50;
  font-size: 14px;
}

.dropdown a:hover
{
  background-color: #ccc;
}

.menu
{
  display: block;
}

#setListName
{
  font-size: 20px;
  overflow: hidden;
}

.medleyStart
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0% 0%, 90% 0, 100% 50%, 90% 100%, 0% 100%, 5% 50% );
}

.medleyCont
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0 15%, 95% 15%, 95% 85%, 0% 85% );
}

.medleyEnd
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0% 0%, 95% 0%, 85% 50%, 95% 100%, 0% 100% );
}

.highlight
{
  color: #d33;
}

.topButtons
{
  background-color: #fdd;
  padding: 10px;
  font-size: 16px;
}

</style>
</head>

<body align="center">
<button class='menuButton' id='newSetButton' onclick='newSetlist();'>New</button>
<button class='menuButton' id='openSetButton' onclick='openSet();'>Open</button>
<button class='menuButton' id='saveSetButton' onclick='saveSet();'>Save</button>
<button class='menuButton' id='exportSetButton' onclick='exportSet();'>Export</button>
<br>
<button class='menuButton' id='modeButton' onclick='changeMode();'>Click to change mode</button>
<p id='setListName' onClick='setSetlistName()'></p>
<hr>
<div id='setlist'> </div>
<hr>
<p3>Library</p3>
<div id='library'> </div>

<script>
var debugFlag = true;
var currentSet, currentSong; // the cursor
// Constants.
const MODE_INSERT = 0;
const MODE_DELETE = 1;
const MODE_EDIT   = 2;

const SET_RENAME  = 0;
const SET_INSERT  = 1;
const SET_DELETE  = 2;
const SET_DUP     = 3;
const SET_UP      = 4;
const SET_DOWN    = 5; 

var operationMode = -1;

window.onload = setListInit;

////////////////////
// API sim for debug
////////////////////

// Return autogenerated LibrarySong{}, keyed by id
function getLibrary()
{
  var numSongs = 100; // randInt( 10, 20 );
  var library = {};

  for( var i = 0;i < numSongs;i++ )
  {
    var lsong = new LibrarySong( "Song " + i.toString(), "Artist " + i.toString() );
    lsong.bpm = 80 + i % 100;
    for( var v = 0;v < 10;v++ )
      lsong.lyrics += "Blah blah blah blah blah blah blah blah\n";

    library[ lsong.id ] = lsong;
  }

  return library;
}

// return available setlist names[].
function getSetlists()
{
  var numLists = randInt( 2, 20 );
  var setLists = [];

  for( var i = 0;i < numLists;i++ )
  {
    var name = "Setlist" + i.toString();
    setLists.push( name );
  }

  return setLists;
}

// return a SetList of the given name
function getSetList( setListName )
{
  setList = new SetList();

  setList.name = setListName;
  var numSets = randInt( 1, 5 );

  for( var setIx = 0;setIx < numSets;setIx++ )
  {
    var newSet = Set();
    newSet.name = "Set" + ( setIx + 1 ).toString();
    var numSongs = randInt( 2, 20 );
    for( var songIx = 0;songIx < numSongs;songIx++ )
    {
      var song = new SetListSong( "Song " + i.toString(), "Artist " + i.toString() );
      newSet.songs.push( song );
    }

    setList.sets.push( newSet );
  }

  return setList;
}

function saveSetlist() { return true; }
function randInt( min, max ) { return Math.floor( Math.random() * ( max - min ) ) + min; }

//////////////////////////// //////////////////////////// ////////////////////////////
//////////////////////////// //////////////////////////// ////////////////////////////
//////////////////////////// //////////////////////////// ////////////////////////////
//////////////////////////// //////////////////////////// ////////////////////////////

function setSetlistName()
{
  var name = prompt( "Enter Setlist Name:", curSetlist.name );
  if( name )
  {
    curSetlist.name = name;
    document.getElementById( "setListName" ).innerHTML = name;
  }
}

// clicking on a library song should add the song at the current cursor position
function libSongClick( songId )
{
  if( debugFlag ) console.log( songId + " " + currentSet + " " + currentSong );

  if( currentSet != "undefined" )
  {
    var libSong = songLibrary[ songId ];
    var newSong = new SetListSong( libSong.name, libSong.artist );
    curSetlist.sets[ currentSet ].songs.splice( currentSong, 0, newSong );

    currentSong += 1;
    updateDisplay();
  }
}

// A Song or set was clicked.
// if mode == MODE_INSERT then set the insertion point
// if mode == MODE_EDIT then first click highlights

function setListClick( elem, setIndex, songIx )
{

  var i;

  if( operationMode == MODE_INSERT )
  {
    // Clear others...
    var insert = document.getElementsByClassName( "insert" );
    for( i = 0;i < insert.length;i++ )
      insert[ i ].classList.remove( 'insert' );

    currentSet = setIndex; // set the cursor
    currentSong = songIx + 1;

    // if( songIx == -1 ) // this is a Set
    //   elem = document.getElementById( 'setMenu' + setIndex );
    // else
    //   elem = document.getElementById( "setListSong" + setIndex + "." + setIndex );

    elem.classList.add( 'insert' );
  }
  else if( operationMode == MODE_EDIT )
  {
    /* Close dropdowns.
    var dropdowns = document.getElementsByClassName( "dropdown-content" );
    for( var i = 0;i < dropdowns.length;i++ )
      dropdowns[ i ].classList.remove( 'menu' );
    */
  }
}

function setOperation( operation, setIndex )
{
  if( debugFlag ) console.log( "setOperation " + operation + setIndex );

  switch( operation )
  {
    case SET_RENAME:
      var name = prompt( "Enter Set Name:", curSetlist.sets[ setIndex ].name );
      if( name )
      {
        curSetlist.sets[ setIndex ].name = name;
        var elem = document.getElementById( "set" + setIndex );
        elem.innerHTML = name;
      }
      break;

    case SET_INSERT:
      newSet = new Set();
      curSetlist.sets.splice( setIndex, 0, newSet );
      break;

    case SET_DELETE:
      if( curSetlist.sets.length > 1 )
        curSetlist.sets.splice( setIndex, 1 );
      else
        alert( "Can't delete last set." );
      break;

    case SET_DUP:
      break;

    case SET_UP:
      break;

    case SET_DOWN:
      break;
  }

  updateDisplay();
}

function updateDisplay()
{
  // if( debugFlag ) console.log( "updateDisplay()" );

  ///////////////
  // draw setlist
  ///////////////
  var tmpHtml = "";
  for( var i = 0;i < curSetlist.sets.length;i++ )
  {
    var s = curSetlist.sets[ i ]; // just for readability

    tmpHtml += "<div class='dropdown'> \n\
                 <button id='setListSet." + i + "' class='dropbtn' onclick='setListClick( this, " + i + ", -1 )'>" + s.name + "</button> \n\
                 <div id='setMenu" + i + "' class='dropdown-content'> \n\
                   <a onclick='setOperation( SET_RENAME," + i + ")'>Rename</a>    \n\
                   <a onclick='setOperation( SET_INSERT," + i + ")'>Insert</a>    \n\
                   <a onclick='setOperation( SET_DELETE," + i + ")'>Delete</a>    \n\
                   <a onclick='setOperation( SET_DUP,   " + i + ")'>Duplicate</a> \n\
                   <a onclick='setOperation( SET_UP,    " + i + ")'>Move Up</a>   \n\
                   <a onclick='setOperation( SET_DOWN,  " + i + ")'>Move Down</a> \n\
                 </div> \n\
               </div>\n";

    for( var j = 0;j < s.songs.length;j++ )
      tmpHtml += "<button id='setListSong." + i + "." + j + "' class='setListSong' onclick='setListClick( this, " + i + ", " + j + " )'>" + s.songs[ j ].name + "</button>";

    tmpHtml += "<br>";
  }

  document.getElementById( 'setlist' ).innerHTML = tmpHtml;

  ///////////////
  // draw library
  ///////////////
  tmpHtml = "";

  for( const[ key, value ] of Object.entries( songLibrary ) )
    tmpHtml += "<button id='" + value.id + "' class='librarySong' onclick=\"libSongClick('" + value.id + "')\">" + value.name + "</button>\n";

  document.getElementById( 'library' ).innerHTML = tmpHtml;
}

class LibrarySong
{
  constructor( name, artist )
  {
    this.name = name;
    this.artist = artist;
    this.id = this.name + '.' + this.artist; // Unique key for Library. 
    this.id = this.id.replace( / /g, "_" );  // replace spaces with _

    this.bpm = undefined;
    this.lyrics = undefined;
  }
}

class SetListSong
{
  constructor( name, artist )
  {
    this.name = name; // name and artist are key to find in library
    this.artist = artist;
    this.id = this.name + '.' + this.artist;
    this.id.replace( / /g, "_" );

    this.highLight = false;
    this.medley = false;
  }
}

var defaultIndex = 0;

class Set
{
  constructor( name )
  {
    if( !name )
    {
      defaultIndex += 1;
      name = "Default " + defaultIndex;
    }
    this.name = name;
    this.songs = []; // SetListSong[]
  }
}

class SetList
{
  constructor( name )
  {
    this.name = name;
    this.sets = []; // Set[]
    var initialSet = new Set( "Set 1" );
    this.sets.push( initialSet );
  }

  export()
  {
    var currentDate = Date.now();
  }
}

///////////////////////// ////////////////////////// ////////////////////////
function newSetlist()
{
  curSetlist = new SetList( "Setlist Name" );
  updateDisplay();
}

function openSet() { }
function saveSet() { }
function exportSet() { }

function changeMode()
{
  operationMode++;
  if( operationMode > MODE_EDIT )
    operationMode = MODE_INSERT;
  var newMode;

  switch( operationMode )
  {
    case MODE_EDIT:   newMode = "Edit";   break;
    case MODE_INSERT: newMode = "Insert"; break;
    case MODE_DELETE: newMode = "Delete"; break;
  }

  document.getElementById( 'modeButton' ).innerHTML = newMode;
}

var songLibrary; // object of LibrarySong
var curSetlist;

function setListInit()
{
  songLibrary = getLibrary();
  newSetlist();
  
  document.getElementById( 'setListName' ).innerHTML = curSetlist.name;

  updateDisplay();
}

</script>
</body>
</html>