<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Set List Creator</title>
<style>

.librarySong
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.setListSong
{
  border: 2px solid white;
  background-color: #def;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.menuButton
{
  border: 2px solid white;
  background-color: #ddf;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.modeButton
{
  border: 2px solid white;
  background-color: #bbf;
  color: #444;
  padding: 6px;
  text-align: left;
  font-size: 10px;
}

.dropbtn:hover
{
  background-color: brown;
}

.setClass
{
  border: 2px solid white;
  background-color: #ddf;
  color: #000;
  padding: 6px;
  text-align: center;
  font-size: 16px;
}

.menu
{
  display: block;
}

#setListName
{
  font-size: 20px;
  overflow: hidden;
}

.medleyStart
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0% 0%, 90% 0, 100% 50%, 90% 100%, 0% 100%, 5% 50% );
}

.medleyCont
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0 15%, 95% 15%, 95% 85%, 0% 85% );
}

.medleyEnd
{
  position:relative;
  overflow:hidden;
  background: #ddf;
  clip-path: polygon( 0% 0%, 95% 0%, 85% 50%, 95% 100%, 0% 100% );
}

.highlight
{
  background-color: #f00;
}

.topButtons
{
  background-color: #fdd;
  padding: 10px;
  font-size: 16px;
}

</style>
</head>

<body align="center">
<button class='menuButton' id='newSetButton'    onclick='newSetlist();'>New</button>
<button class='menuButton' id='openSetButton'   onclick='changeMode( MODE_OPEN );'>Open</button>
<button class='menuButton' id='saveSetButton'   onclick='saveSetlist();'>Save</button>
<button class='menuButton' id='exportSetButton' onclick='exportSet();'>Export</button>
<hr>
<button class='modeButton' id='modeAddButton' onclick='changeMode( MODE_ADD );'>Add</button>
<button class='modeButton' id='modeDeleteButton' onclick='changeMode( MODE_DELETE );'>Delete</button>
<button class='modeButton' id='modeMoveButton' onclick='changeMode( MODE_MOVE );'>Move</button>

<hr>
<p id='setListName' onClick='setSetlistName()'></p>
<div id='setlist'> </div>
<hr>
<p3>Library</p3>
<div id='library'> </div>

<script>
var curSet, curSong; // The cursor for various operations
var editedFlag = false;
var setLists = {};  // set lists available in library.
var songLibrary;    // object of LibrarySong[]
var curSetList;

// Constants.
const MODE_NONE   = 0;
const MODE_ADD    = 1;
const MODE_DELETE = 2; // delete songs
const MODE_MOVE   = 3;
const MODE_OPEN   = 4;
const MODE_DEL_SET = 5; // want to delete a set

const SET_RENAME  = 0;
const SET_INSERT  = 1;
const SET_DELETE  = 2;

var operationMode = MODE_NONE;

window.onload = setListInit;

////////////////////
// API sim for debug
////////////////////

// Return autogenerated LibrarySong{}, keyed by id
function getLibrary()
{
  var numSongs = 100; // randInt( 10, 20 );
  var library = {};

  for( var i = 0;i < numSongs;i++ )
  {
    var lsong = new LibrarySong( "Song " + i.toString(), "Artist " + i.toString() );
    lsong.bpm = 80 + i % 100;
    for( var v = 0;v < 10;v++ )
      lsong.lyrics += "Blah blah blah blah blah blah blah blah\n";

    library[ lsong.id ] = lsong;
  }

  return library;
}

// Return SetList[] of lists in the database.
function getSetLists()
{
  var sLists = {};

  for( var i = 0;i < 10;i++ )
  {
    var songIndex = 0;

    setList = new SetList();

    setList.name = "Dummy Set " + i.toString();;
    var numSets = randInt( 2, 7 );

    for( var setIx = 0;setIx < numSets;setIx++ )
    {
      var newSet = new Set();
      newSet.name = "Set" + ( setIx + 1 ).toString();
      var numSongs = randInt( 2, 20 );
      for( var songIx = 0;songIx < numSongs;songIx++ )
      {
        songIndex += 1;
        var song = new SetListSong( "Song " + songIndex.toString(), "Artist " + songIndex.toString() );
        newSet.songs.push( song );
      }

      setList.sets[ setIx ] = newSet;
    }

    sLists[ setList.name ] = setList;
  }

  return sLists;
}

function randInt( min, max ) { return Math.floor( Math.random() * ( max - min ) ) + min; }

// Stolen from https://javascript.plainenglish.io/how-to-deep-copy-objects-and-arrays-in-javascript-7c911359b089
const deepCopy = ( inObject ) =>
{
  let outObject, value, key;

  if( typeof inObject !== "object" || inObject === null )
    return inObject;

  outObject = Array.isArray( inObject ) ? [] : {};

  for( key in inObject )
  {
    value = inObject[ key ];
    outObject[ key ] = deepCopy( value );
  }

  return outObject
}

//////////////////////////// //////////////////////////// ////////////////////////////
//////////////////////////// //////////////////////////// ////////////////////////////
//////////////////////////// //////////////////////////// ////////////////////////////
//////////////////////////// //////////////////////////// ////////////////////////////

class LibrarySong
{
  constructor( name, artist )
  {
    this.name = name;
    this.artist = artist;
    this.id = this.name + '.' + this.artist; // Unique key for Library. 
    this.id = this.id.replace( / /g, "_" );  // replace spaces with _

    this.bpm = undefined;
    this.lyrics = undefined;
  }
}

class SetListSong
{
  constructor( name, artist )
  {
    this.name = name; // name and artist are key to find in library
    this.artist = artist;
    this.id = this.name + '.' + this.artist;
    this.id.replace( / /g, "_" );

    this.highLight = false;
    this.medley = false;
  }
}

class Set
{
  constructor( name )
  {
    if( !name )
      name = "Set";

    this.name = name;
    this.songs = []; // SetListSong[]
  }
}

class SetList
{
  constructor( name )
  {
    this.name = name;
    this.sets = []; // Set[]
    var initialSet = new Set();
    this.sets.push( initialSet );
  }

  export() { var currentDate = Date.now(); }
}

// get the cursor element.
function getCurrentElement()
{
  var elemId, elem;

  if( !curSet )
    return undefined;

  elemId = ( curSong == undefined ) ? "setListSet." + curSet : "setListSong." + curSet + "." + curSong;

  if( elemId )
    elem = document.getElementById( elemId );
  
  return elem;
}

function saveSetlist()
{
  setLists[ curSetList.name ] = deepCopy( curSetList );
  setEditedState( false );
  return true;
}

function setSetlistName()
{
  var name = prompt( "Enter Setlist Name:", curSetList.name );
  if( name )
  {
    curSetList.name = name;
    document.getElementById( "setListName" ).innerHTML = name;
    setEditedState( true );
  }
}

// A Song or set was clicked.
function slClick( setIndex, songIndex )
{
  if( operationMode == MODE_ADD ) // what we click on becomes the insertion point.
  {
    curSet = setIndex; // set the cursor
    curSong = songIndex;
  }
  else if( operationMode == MODE_DELETE )
  {
    if( songIndex == undefined )
      curSetList.sets.splice( setIndex, 1 );
    else
      curSetList.sets[ setIndex ].songs.splice( songIndex, 1 );
 
    setEditedState( true );
  }
  else if( operationMode == MODE_MOVE ) 
  {
    if( curSet == undefined ) // First click highlights the song we want to move
    {
      if( songIndex != -1 )
      {
        curSet = setIndex;
        curSong = songIndex;
      }
    }
    else // This is the 2nd click.
    {
      setEditedState( true );

      if( curSong == undefined ) // moving sets ( 1st click was a set )
      {
        if( songIndex == undefined ) // clicked on a set, do the move.
        {
          if( setIndex < curSet ) // moved set up
          {
            curSetList.sets.splice( setIndex, 0, curSetList.sets[ curSet ] );
            curSetList.sets.splice( curSet + 1, 1 );
          }
          else
          {
            curSetList.sets.splice( setIndex + 1, 0, curSetList.sets[ curSet ] );
            curSetList.sets.splice( curSet, 1 );
          }
          curSet = undefined;
        }
      }
      else // moving songs
      {
        if( ( setIndex != curSet ) || ( songIndex != curSong ) )
        {
          if( setIndex == curSet ) // moving within the same set
          {
            if( songIndex == -1 ) // clicked on the +
              songIndex = curSetList.sets[ setIndex ].songs.length - 1;
            if( songIndex != undefined )
            {
              if( songIndex < curSong ) // moved song up
              {
                curSetList.sets[ setIndex ].songs.splice( songIndex, 0, curSetList.sets[ curSet ].songs[ curSong ] );
                curSetList.sets[ curSet ].songs.splice( curSong + 1, 1 );
              }
              else
              {
                curSetList.sets[ setIndex ].songs.splice( songIndex + 1, 0, curSetList.sets[ curSet ].songs[ curSong ] );
                curSetList.sets[ curSet ].songs.splice( curSong, 1 );
              }
            }
          }
          else
          {
            if( songIndex == -1 ) // clicked on the +
              songIndex = curSetList.sets[ setIndex ].songs.length;
            if( songIndex != undefined )
            {
              curSetList.sets[ setIndex ].songs.splice( songIndex, 0, curSetList.sets[ curSet ].songs[ curSong ] );
              curSetList.sets[ curSet ].songs.splice( curSong, 1 );
            }
          }
        }
        curSet = undefined;
        curSong = undefined;
      }
    }

  }
  else if( songIndex == undefined )
    setRename( setIndex );

  generateHTML(); 
}

// clicking on a library song should add the song at the current cursor position
function libSongClick( songId )
{
  if( operationMode == MODE_ADD )
    if( curSet != undefined )
    {
      var libSong = songLibrary[ songId ];
      var newSong = new SetListSong( libSong.name, libSong.artist );

      if( curSong == undefined )
      {
        curSetList.sets[ curSet ].songs.unshift( newSong );
        curSong = 0;
      }
      else
      {
        curSong++;
        curSetList.sets[ curSet ].songs.splice( curSong, 0, newSong );
      }
      setEditedState( true );
      generateHTML();
    }
}

function setRename( setIndex )
{
  var name = prompt( "Enter Set Name:", curSetList.sets[ setIndex ].name );
  if( name )
  {
    curSetList.sets[ setIndex ].name = name;
    var elem = document.getElementById( "setListSet." + setIndex );
    elem.innerHTML = name;
  }

  generateHTML();
}

function setClicked( setName )
{
  if( operationMode == MODE_DEL_SET )
  {
    delete setLists[ setName ];
    generateHTML();
  }
  else
  {
    curSetList = deepCopy( setLists[ setName ] );
    changeMode( MODE_NONE );
  }
}

function setAdd()
{
  curSetList.sets.push( new Set() );
  setEditedState( true );
  generateHTML();
}

////////////////////////////// //////////////////////////////
// Generate main panel's html. Usually the set list itself
////////////////////////////// //////////////////////////////
function generateHTML()
{
  var tempHtml = "";

  if( ( operationMode == MODE_OPEN ) || ( operationMode == MODE_DEL_SET ) )
  {
    document.getElementById( "setListName" ).innerHTML = "Choose a set:";

    let slCount = 0;
    for( const[ k, o ] of Object.entries( setLists ) )
    {
      tempHtml += "<button class='setListName' onclick='setClicked( \"" + k + "\" )'>" + k + "</button>\n<br>";
      slCount++;
    }
    if( !slCount )
      operationMode = MODE_NONE;

    tempHtml += "<br>";
    document.getElementById( 'setlist' ).innerHTML = tempHtml;
  }
  else // in other modes this panel shows the current set list.
  {
    document.getElementById( "setListName" ).innerHTML = curSetList.name;

    for( var i = 0;i < curSetList.sets.length;i++ )
    {
      var s = curSetList.sets[ i ];
      tempHtml += "<button id='setListSet." + i + "' class='setClass' onclick='slClick( " + i + ", undefined )'>" + s.name + "</button>\n";

      for( var j = 0;j < s.songs.length;j++ )
        tempHtml += "<button id='setListSong." + i + "." + j + "' class='setListSong' onclick='slClick( " + i + ", " + j + " )'>" + s.songs[ j ].name + "</button>\n";

      if( operationMode == MODE_MOVE ) // add a '+' at the end so when moving songs across sets we can place them at the end of a set.
        tempHtml += "<button class='setListSong' onclick='slClick( " + i + ", -1 )'> + </button>";

      tempHtml += "<br>";
    }
    tempHtml += "<button class='setClass' onclick='setAdd()'> + </button>\n"; // Add a + to create a new set

    document.getElementById( 'setlist' ).innerHTML = tempHtml;

    var elem = getCurrentElement();
    if( elem )
      elem.classList.add( 'highlight' ); // indicate cursor
  }
}

function generateLibraryHTML()
{
  var tmpHtml = "";
  for( const[ key, value ] of Object.entries( songLibrary ) )
    tmpHtml += "<button id='" + value.id + "' class='librarySong' onclick=\"libSongClick('" + value.id + "')\">" + value.name + "</button>\n";
  document.getElementById( 'library' ).innerHTML = tmpHtml;
}

function setEditedState( newState )
{
  var elem = document.getElementById( 'saveSetButton' );
  editedFlag = newState;
  if( editedFlag )
    elem.classList.add( 'highlight' );
  else
    elem.classList.remove( 'highlight' );
}

///////////////////////// ////////////////////////// ////////////////////////
function newSetlist()
{
  if( editedFlag )
  {
    if( !window.confirm( "Unsaved Edits. Continue?" ) )
      return;
    setEditedState( false );
  }

  curSetList = new SetList( "SET LIST" );
  document.getElementById( 'setListName' ).innerHTML = curSetList.name;
  generateHTML();
}

function exportSet() { }

function changeMode( mode )
{
  if( ( mode == MODE_DELETE ) && ( operationMode == MODE_OPEN ) )
    operationMode = MODE_DEL_SET;
  else if( ( mode == MODE_DELETE ) && ( operationMode == MODE_DEL_SET ) )
    operationMode = MODE_OPEN;
  else
    operationMode = ( mode == operationMode ) ? MODE_NONE : mode;

  if( ( operationMode == MODE_OPEN ) && editedFlag )
  {
    if( !window.confirm( "Unsaved Edits. Continue?" ) )
      operationMode = MODE_NONE;
    else
      setEditedState( false );
  }

  var buttons = document.getElementsByClassName( 'modeButton' );
  for( i = 0;i < buttons.length;i++ )
    buttons[ i ].classList.remove( 'highlight' );
  buttons = document.getElementsByClassName( 'menuButton' );
  for( i = 0;i < buttons.length;i++ )
    buttons[ i ].classList.remove( 'highlight' );

  if( operationMode != MODE_NONE )
  {
    var elem;
    switch( operationMode )
    {
      case MODE_OPEN:   elem = document.getElementById( 'openSetButton' );    break;
      case MODE_ADD:    elem = document.getElementById( 'modeAddButton' );    break;
      case MODE_DEL_SET:
      case MODE_DELETE: elem = document.getElementById( 'modeDeleteButton' ); break;
      case MODE_MOVE:   elem = document.getElementById( 'modeMoveButton' );   break;
    }
    elem.classList.add( 'highlight' );
  }

  curSet = undefined;
  curSong = undefined;

  generateHTML();
}

function setListInit()
{
  songLibrary = getLibrary();

  setLists = getSetLists();
  generateLibraryHTML();
  newSetlist();
}

</script>
</body>
</html>